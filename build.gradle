plugins {
    id 'com.github.johnrengelman.shadow' version '5.1.0'
    id "io.freefair.lombok" version "4.1.3"
}

apply plugin: "distribution"
apply plugin: "java"
apply plugin: "maven"
apply plugin: "application"
apply plugin: 'com.github.johnrengelman.shadow'

repositories {
    mavenLocal()
    mavenCentral()
    maven {
        url "https://oss.jfrog.org/artifactory/jfrog-dependencies"
    }
}

group = "io.pravega"
version = releaseVersion

description = "Boomi Pravega Connector"
sourceCompatibility = 1.8
targetCompatibility = 1.8

dependencies {
    compile "io.pravega:pravega-client:${pravegaVersion}"
    compile "org.json:json:${jsonVersion}"
    //compile "com.fasterxml.jackson.core:jackson-databind:${jacksonVersion}"
    compile "com.boomi:connector-sdk-util:${boomiSdkVersion}"
    compileOnly "com.boomi:connector-sdk-api:${boomiSdkVersion}"
    testCompile "com.boomi:connector-sdk-test-util:${boomiSdkVersion}"
    // https://mvnrepository.com/artifact/net.sf.proguard/proguard-gradle
    //compileOnly group: 'net.sf.proguard', name: 'proguard-gradle', version: '6.2.0'
}

shadowJar {
    //zip64 true
    //entryCompression = org.gradle.api.tasks.bundling.ZipEntryCompression.STORED
    append('META-INF/connector-config')
    manifest {
        attributes 'Implementation-Version': project.version
    }
    //configurations = [project.configurations.compile]
    mergeServiceFiles()
    dependencies {
        exclude(dependency('io.netty:netty-all:.*'))
        exclude(dependency('org.projectlombok:lombok:.*'))
        exclude(dependency('com.google.guava:guava:26.0-android'))
        exclude(dependency('com.google.errorprone:error_prone_annotations:.*'))
        exclude(dependency('com.google.guava:failureaccess:.*'))
        exclude(dependency('org.checkerframework:checker-qual:.*'))
        exclude(dependency('com.google.guava:listenablefuture:.*'))
        exclude(dependency('com.google.errorprone:error_prone_annotations:.*'))
        exclude(dependency('com.google.j2objc:j2objc-annotations:.*'))
        exclude(dependency('org.codehaus.mojo:animal-sniffer-annotations:.*'))

        exclude(dependency('com.fasterxml.jackson.core:jackson-core:.*'))
        exclude(dependency('io.netty:netty-handler-proxy:.*'))
        exclude(dependency('com.fasterxml.jackson.core:jackson-databind:.*'))
        exclude(dependency('ch.qos.logback:logback-classic:.*'))
        exclude(dependency('io.netty:netty-tcnative-boringssl-static:.*'))
        exclude(dependency('commons-io:commons-io:.*'))
        exclude(dependency('com.google.api.grpc:proto-google-common-protos:.*'))
        exclude(dependency('io.netty:netty-codec-socks:.*'))
        exclude(dependency('com.google.code.gson:gson:.*'))
        exclude(dependency('com.google.errorprone:error_prone_annotations:.*'))
        exclude(dependency('com.google.code.findbugs:jsr305:.*'))
        exclude(dependency('org.codehaus.mojo:animal-sniffer-annotations:.*'))
        exclude(dependency('com.google.guava:failureaccess:.*'))
        exclude(dependency('com.google.guava:listenablefuture:9999.0-empty-to-avoid-conflict-with-guava'))
        exclude(dependency('org.checkerframework:checker-qual:.*'))
        exclude(dependency('com.google.j2objc:j2objc-annotations:.*'))
        exclude(dependency('org.codehaus.mojo:animal-sniffer-annotations:.*'))
        exclude(dependency('io.netty:netty-transport-native-unix-common:.*'))
        exclude(dependency('io.grpc:grpc-auth:.*'))
        exclude(dependency('com.fasterxml.jackson.core:jackson-annotations:.*'))
        exclude(dependency('io.netty:netty-handler-proxy:.*'))
        exclude(dependency('io.netty:netty-transport-native-unix-common:.*'))
    }

}

distributions {
    main {
        baseName = archivesBaseName
        contents {
            into('META-INF') {
                from(project.file('src/main/resources/connector-config.xml'))
            }
            into('lib') {
                from shadowJar
                //from(jar)
                //from(project.configurations.runtime)
                //from(project.configurations.shadow)
            }
        }
    }
}

task buildZip(type: Zip) {
    from compileJava
    from processResources
    //exclude '**/shop/product/data/**'
    archiveFileName = "pravega-boomi-connector.zip"
    destinationDirectory = file("$buildDir/dist")
    from shadowJar
    include 'META-INF/**'
    include 'connector-descriptor'
}

build.dependsOn buildZip
