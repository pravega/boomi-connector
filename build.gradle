/*
 * This build file was generated by the Gradle 'init' task.
 *
 * This generated file contains a commented-out sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at https://docs.gradle.org/3.4.1/userguide/tutorial_java_projects.html
 */
plugins {
    id 'com.github.johnrengelman.shadow' version '5.1.0'
}

plugins {
    id "com.github.gradle-lean" version "0.1.2"
}

apply plugin: "distribution"
apply plugin: "java"
apply plugin: "maven"
apply plugin: "application"
apply plugin: "maven-publish"
apply plugin: 'com.github.johnrengelman.shadow'



configurations.all {
    // Check for updates every build
    resolutionStrategy.cacheChangingModulesFor 0, "seconds"
}

repositories {
    mavenLocal()
    mavenCentral()
    maven {
        url "https://repository.apache.org/snapshots"
    }
    maven {
        url "https://oss.sonatype.org/content/repositories/snapshots"
    }
    maven {
            url "file://C:/Users/chennv4/.m2"
        }
}


archivesBaseName = 'boomi-connector'

group = "com.boomi.connector.pravega"
version = samplesVersion

description = "boomi-connector"
mainClassName = "com.boomi.connector.pravega.HelloWorldReader"
sourceCompatibility = 1.8
targetCompatibility = 1.8

dependencies {
    compile "io.pravega:pravega-client:${pravegaVersion}"
    compile "org.slf4j:slf4j-api:${slf4jApiVersion}"
    compile "ch.qos.logback:logback-classic:${logbackVersion}"
    compile "ch.qos.logback:logback-core:${logbackVersion}"
    compile "com.fasterxml.jackson.core:jackson-databind:2.9.1"
    compile "connector.sdk:connector.sdk.api:1.3.2"
    compile "connector.sdk:connector.sdk.util:1.3.2"
    compile 'connector.sdk:connector.sdk.test.util:1.3.2'
    compile "boomi.util:boomi.util:1.3.2"
    compile 'org.json:json:20190722'
    // https://mvnrepository.com/artifact/net.sf.proguard/proguard-gradle
    compileOnly group: 'net.sf.proguard', name: 'proguard-gradle', version: '6.2.0'

 }

 shadowJar {
    //zip64 true
    //entryCompression = org.gradle.api.tasks.bundling.ZipEntryCompression.STORED
    classifier = 'SNAPSHOT'
    append('META-INF/connector-config')
    manifest {
        attributes 'Implementation-Version': project.version                
    }
    //configurations = [project.configurations.compile]
    mergeServiceFiles()
    dependencies {
    exclude(dependency('io.netty:netty-all:.*'))
    exclude(dependency('org.projectlombok:lombok:.*'))
    exclude(dependency('com.google.guava:guava:26.0-android'))
    exclude(dependency('com.google.errorprone:error_prone_annotations:.*'))
    exclude(dependency('com.google.guava:failureaccess:.*'))
    exclude(dependency('org.checkerframework:checker-qual:.*'))
    exclude(dependency('com.google.guava:listenablefuture:.*'))
    exclude(dependency('com.google.errorprone:error_prone_annotations:.*'))
    exclude(dependency('com.google.j2objc:j2objc-annotations:.*'))
    exclude(dependency('org.codehaus.mojo:animal-sniffer-annotations:.*'))

    exclude(dependency('com.fasterxml.jackson.core:jackson-core:.*'))
    exclude(dependency('io.netty:netty-handler-proxy:.*'))
    exclude(dependency('com.fasterxml.jackson.core:jackson-databind:.*')) 
    exclude(dependency('ch.qos.logback:logback-classic:.*'))
    exclude(dependency('io.netty:netty-tcnative-boringssl-static:.*'))
    exclude(dependency('commons-io:commons-io:.*'))
    exclude(dependency('com.google.api.grpc:proto-google-common-protos:.*'))
    exclude(dependency('io.netty:netty-codec-socks:.*'))
    exclude(dependency('com.google.code.gson:gson:.*'))
    exclude(dependency('com.google.errorprone:error_prone_annotations:.*'))
    exclude(dependency('com.google.code.findbugs:jsr305:.*'))
    exclude(dependency('org.codehaus.mojo:animal-sniffer-annotations:.*'))
    exclude(dependency('com.google.guava:failureaccess:.*'))
    exclude(dependency('com.google.guava:listenablefuture:9999.0-empty-to-avoid-conflict-with-guava'))
    exclude(dependency('org.checkerframework:checker-qual:.*'))
    exclude(dependency('com.google.j2objc:j2objc-annotations:.*'))
    exclude(dependency('org.codehaus.mojo:animal-sniffer-annotations:.*'))
    exclude(dependency('io.netty:netty-transport-native-unix-common:.*'))
    exclude(dependency('io.grpc:grpc-auth:.*'))
    exclude(dependency('com.fasterxml.jackson.core:jackson-annotations:.*'))
    exclude(dependency('io.netty:netty-handler-proxy:.*'))
    exclude(dependency('io.netty:netty-transport-native-unix-common:.*'))

    
    exclude(dependency('connector.sdk:connector.sdk.api:.*'))
    exclude(dependency('connector.sdk:connector.sdk.util:.*'))
    exclude(dependency('boomi.util:boomi.util:.*'))     
    }
    
}

task listAllDependencies(type: DependencyReportTask) {}


distributions {
    main {
        baseName = archivesBaseName
        contents {
            from(project.file('connector-descriptor.xml'))
            from(project.file('META-INF/*'))
            /*into('bin') {

            }*/
            into('lib') {
                //from(jar)
                //from(project.configurations.runtime)
                from shadowJar
                //from(project.configurations.shadow)
            }
            into('conf') {
                from(project.file('src/main/resources/logback.xml'))
            }
        }
    }

task buildZip(type: Zip) {
    from compileJava
    from processResources
    //exclude '**/shop/product/data/**'
    archiveFileName = "pravega-boomi-connector.zip"
    destinationDirectory = file("$buildDir/dist")
    from shadowJar
    include 'META-INF/**'
    include 'connector-descriptor'
}

//create a single Jar with all dependencies
/*task fatJar(type: Jar) {
    manifest {
        attributes 'Implementation-Version': project.version 
    }
    baseName = project.name + '-all'
    from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } }
    with jar
}*/

/*jar {
    manifest {
        attributes "Main-Class": mainClassName
    }
 
    from {
        configurations.runtime.collect { it.isDirectory() ? it : zipTree(it) }
    }


}*/

//jar.dependsOn copyJarsToLib

task copyJarsToLib (type: Copy) {
    def toDir = "build/libs/dependency-jars"

    // create directories, if not already done:
    file(toDir).mkdirs()

    // copy jars to lib folder:
    from configurations.runtime
    into toDir
}

/*task uberJar(type: Jar) {
    archiveClassifier = 'uber'

    from sourceSets.main.output

    dependsOn configurations.runtimeClasspath
    from {
        configurations.runtimeClasspath.findAll { it.name.endsWith('jar') }.collect { zipTree(it) }
    }
}*/

build.dependsOn buildZip

publishing {
    repositories {
        maven {
            credentials {
                username userName
                password passWord
            }
            url projectRepoUrl
        }
    }
    publications {
        shadow(MavenPublication) { publication ->
             project.shadow.component(publication)
            }
        }
    }
}